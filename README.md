# WordPress Complete Cleanup Script

> [!WARNING]
> **重要: 免責事項と自己責任での利用について**
> このプログラムを盲信せず、実行前に必ずご自身でコードの内容を確認するか、AI等にチェックさせて安全性を確認してください。
> 本スクリプトの利用は**完全な自己責任**となります。本スクリプトの実行によって発生したデータの消失（意図しない削除を含む）やシステムの不具合について、制作者はいかなる責任も負いません。

WordPressの不要な環境（データベースのテーブルおよびWordPressコアファイル・ディレクトリ）を安全かつ完全に削除・初期化するための単一PHPスクリプトです。

対象のデータベースプレフィックスを持つテーブルのみを削除し、さらにホワイトリスト方式のファイル削除を行うため、共用サーバーで他のアプリが同居している場合でも安全にWordPressのみをクリーンアップできます。

## 主な特徴

- **単一ファイルで動作**: `wp-cleanup.php` をアップロードするだけですぐに使えます。
- **安全なデータベース削除**: `wp-config.php` を自動で解析し、設定されたプレフィックス(`$table_prefix`)を持つテーブルのみをDROPします。
- **ホワイトリスト方式のファイル削除**: `wp-admin`, `wp-includes`, `wp-content` ディレクトリや、`index.php`, `wp-*.php` などのWordPress既知のファイルのみを削除します。自作のファイルや特定の別アプリは保護されます。
- **セキュリティ機能**: 
  - パスワードハッシュによる認証
  - IPベースのブルートフォース攻撃対策（ロックアウト機能）
  - CSRFトークンによる保護
  - 実行有効期限の設定（期限切れで自動削除）
- **マルチサイト・入れ子検出**: クリーンアップ対象外の入れ子になったWordPressなどを事前に検出して警告します。

## 動作要件

- PHP 7.4 以上
- mysqli 拡張機能

## 使い方

### 1. パスワードハッシュの生成

スクリプトにアクセスするためのパスワードをハッシュ化します。コマンドラインで以下を実行してください。

```bash
php -r "echo password_hash('your-password', PASSWORD_DEFAULT);"
```

> 例: `your-password` の部分を任意のパスワードに変更してください。

### 2. スクリプトの編集

ダウンロードした `wp-cleanup.php` をエディタで開き、先ほどのハッシュ値を設定します。

```php
// 30行目付近にある PASSWORD_HASH を変更
define('PASSWORD_HASH', '$2y$10$CHANGE_THIS_TO_YOUR_HASH');
```

必要に応じて、スクリプトの有効期限（`EXPIRES_AT`）もUNIXタイムスタンプで設定できます（デフォルトは `0` = 無制限ですが、セキュリティ上は設置後24時間等に設定することを推奨します）。

### 3. アップロードと実行

1. `wp-cleanup.php` を対象となるWordPressのルートディレクトリ（`wp-config.php` がある場所）にFTP等でアップロードします。
2. ブラウザから `https://yourdomain.com/wp-cleanup.php` にアクセスします。
3. 手順1で設定したパスワード（ハッシュ化する前の文字列）を入力してログインします。
4. 画面の指示に従い、削除されるテーブルとファイルを確認の上、「削除を実行する」ボタンをクリックします。

### 4. 完了後

セキュリティのため、実行完了後は必ず `wp-cleanup.php` をサーバー上から削除してください。

## 注意事項

- **この操作は取り消せません。** 実行前に必ずデータベースおよびファイルのバックアップを取得してください。
- データベースユーザーに `DROP` 権限が必要です。
- シンボリックリンクは追従せず、リンク自体を削除します。
- 本スクリプトはテーブルのみを削除し、**データベース自体は削除しません**。全テーブル削除後も空のデータベースが残ります。不要な場合はphpMyAdminやサーバーのコントロールパネルから手動で削除してください。

## ライセンス

[LICENSE](./LICENSE) を参照してください。
